---
phase: 04-ai-companion
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ai/contextualRAG.ts
  - src/components/article/TextSelectionTrigger.tsx
  - src/components/article/ContextualExplorePanel.tsx
  - src/components/article/ArticleBody.tsx
  - src/app/(app)/article/[id]/page.tsx
autonomous: true
requirements:
  - CTX-01
  - CTX-02
  - CTX-03
  - CTX-04
  - CTX-05
  - CTX-06

must_haves:
  truths:
    - "User can select text in the article and see a floating 'Explore' button appear near the selection"
    - "Clicking 'Explore' opens a side panel to the right without navigating away from the article"
    - "The side panel shows a simulated AI cultural context response for the selected text"
    - "The side panel shows 2-3 related article links below the AI response"
    - "The panel response carries a depth label ('General' or 'Academic') matching the user's profile type"
    - "User can dismiss the panel with an X button and return to reading"
  artifacts:
    - path: "src/ai/contextualRAG.ts"
      provides: "Deterministic mock contextual AI response given selected text"
      exports: ["getContextualResponse"]
    - path: "src/components/article/TextSelectionTrigger.tsx"
      provides: "Detects text selection in article, shows floating Explore button"
      min_lines: 40
    - path: "src/components/article/ContextualExplorePanel.tsx"
      provides: "Side panel with AI response, depth label, related links, dismiss"
      min_lines: 60
  key_links:
    - from: "src/components/article/TextSelectionTrigger.tsx"
      to: "src/components/article/ContextualExplorePanel.tsx"
      via: "selectedText state passed via props or callback"
      pattern: "selectedText|onExplore"
    - from: "src/components/article/ContextualExplorePanel.tsx"
      to: "src/ai/contextualRAG.ts"
      via: "getContextualResponse(selectedText)"
      pattern: "getContextualResponse"
    - from: "src/app/(app)/article/[id]/page.tsx"
      to: "TextSelectionTrigger + ContextualExplorePanel"
      via: "article page layout wraps body in selection-aware container"
      pattern: "TextSelectionTrigger|ContextualExplorePanel"
---

<objective>
Enable text selection-triggered contextual AI exploration inside the article reader.

Purpose: This is the signature CULTX feature — a reader selects any text, taps Explore, and gets instant cultural context without leaving the article. This is the core portfolio differentiator.
Output: TextSelectionTrigger component, ContextualExplorePanel, contextualRAG mock function, article page wired to support the explore flow.
</objective>

<execution_context>
@/Users/jccruzb-local/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jccruzb-local/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/types.ts
@src/lib/profile.ts
@src/lib/constants.ts
@src/components/article/ArticleBody.tsx
@src/app/(app)/article/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create contextualRAG mock AI function</name>
  <files>src/ai/contextualRAG.ts</files>
  <action>
    Create `src/ai/` directory and `contextualRAG.ts` with a deterministic mock function:

    ```ts
    export interface ContextualResponse {
      explanation: string;
      depthLabel: "General" | "Academic";
      relatedLinks: Array<{ title: string; id: string }>;
    }

    export function getContextualResponse(
      selectedText: string,
      profileType: string | null
    ): ContextualResponse
    ```

    Implementation rules:
    - `depthLabel` is `"Academic"` if `profileType === "Academic"` or `profileType === "Cultural professional"`, otherwise `"General"`
    - `explanation`: Return one of 4-5 pre-written cultural responses based on which word index the selectedText hashes to (use `selectedText.length % 5` to pick). Each response must be 2-3 sentences of genuine cultural content about Mexican art/history/culture (not lorem ipsum). Example responses:
      1. "El muralismo mexicano emergió como respuesta a la Revolución de 1910, buscando crear un arte público accesible para todos los ciudadanos. Artistas como Diego Rivera y José Clemente Orozco transformaron paredes de edificios públicos en narrativas épicas de identidad nacional."
      2. "La arquitectura prehispánica en México refleja una profunda comprensión astronómica. Los templos estaban alineados para capturar los equinoccios, convirtiendo cada edificio en un instrumento de medición del tiempo sagrado."
      3. "El teatro de calle en México tiene raíces en los 'pastorelas' coloniales y las danzas rituales indígenas. Esta tradición híbrida sigue viva en festivales comunitarios donde lo sagrado y lo festivo se entrelazan."
      4. "La cerámica de Talavera de Puebla es Patrimonio Cultural Inmaterial de la UNESCO desde 2019. Su técnica de esmalte en dos cocciones fue traída por artesanos españoles en el siglo XVI y fusionada con tradiciones locales."
      5. "El son jarocho es mucho más que música: es un sistema de convivencia social llamado 'fandango'. Las tarimas donde se zapatea no son escenario sino espacio comunitario donde todos participan."
    - Academic variant appends: `"\n\nReferencias: [Fuente simulada] Florescano, E. (2006). *Imágenes de la patria*. México: Taurus."` if depthLabel is Academic
    - `relatedLinks`: Return 2 article IDs from the mock articles. Use `["articulo-muralismo-rivera", "articulo-talavera-puebla"]` as static related links — these are referenced in the data layer.
    - Function is pure and deterministic: same `selectedText` length → same response index → same output.
    - No async, no external calls, no import of real AI libraries.
  </action>
  <verify>
    Run `npx tsc --noEmit` from project root — zero TypeScript errors.
    Confirm `src/ai/contextualRAG.ts` exports `getContextualResponse` and `ContextualResponse`.
  </verify>
  <done>
    `getContextualResponse("muralismo", "Academic")` returns an object with `depthLabel: "Academic"`, a non-empty Spanish explanation with "Referencias:" appended, and an array of 2 related link objects.
    `getContextualResponse("muralismo", "General")` returns same shape but no "Referencias:" and `depthLabel: "General"`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build TextSelectionTrigger and ContextualExplorePanel</name>
  <files>
    src/components/article/TextSelectionTrigger.tsx
    src/components/article/ContextualExplorePanel.tsx
    src/components/article/ArticleBody.tsx
    src/app/(app)/article/[id]/page.tsx
  </files>
  <action>
    ## TextSelectionTrigger.tsx

    Create `"use client"` component that:
    - Wraps its `children` in a `<div>` with a `onMouseUp` handler (and `onTouchEnd` for mobile)
    - On mouse-up: calls `window.getSelection()`. If selected text length >= 10 characters, records `selectedText` in local state and shows a floating button.
    - Floating "Explorar" button: positioned using `getBoundingClientRect()` of the selection range — place button 8px above the selection's top, horizontally centered. Use `position: fixed`. Button contains: Magnifying Glass icon (Phosphor `MagnifyingGlass`, weight="thin") + text "Explorar".
    - Button styles: `backgroundColor: "var(--color-accent)"`, white text, `fontFamily: "var(--font-ui)"`, `fontSize: "0.75rem"`, `borderRadius: "var(--radius-full)"`, `padding: "6px 12px"`, 200ms ease transition, `zIndex: 50`.
    - On "Explorar" button click: calls `onExplore(selectedText)` prop callback, then clears selection and hides button.
    - Clicking outside the selection clears `selectedText` and hides the button (handle with `document.addEventListener("selectionchange")`).
    - Props interface: `{ children: React.ReactNode; onExplore: (text: string) => void }`

    ## ContextualExplorePanel.tsx

    Create `"use client"` component that renders a slide-in side panel:
    - Props: `{ selectedText: string | null; profileType: string | null; articleId: string; onClose: () => void }`
    - When `selectedText` is null/empty, render nothing (return null).
    - When `selectedText` is set, call `getContextualResponse(selectedText, profileType)` synchronously and render:
      - Panel container: `position: fixed`, `top: 0`, `right: 0`, `width: min(400px, 90vw)`, `height: 100vh`, `zIndex: 40`, `overflow-y: auto`, `backgroundColor: "var(--color-surface)"`, `borderLeft: "1px solid var(--color-border)"`, `boxShadow: "var(--shadow-md)"`. Add `transition: transform 200ms ease-in-out`.
      - Header row: depth label pill (small badge, `backgroundColor: "var(--color-surface-raised)"`, `color: "var(--color-text-muted)"`, `fontSize: "0.7rem"`, `borderRadius: "var(--radius-sm)"`, uppercase text showing `response.depthLabel`) + X close button (`X` Phosphor icon, weight="thin", calls `onClose`). Close button has accessible `aria-label="Cerrar panel"`.
      - Selected text quote: display `selectedText` in italic, `fontFamily: "var(--font-display)"`, `color: "var(--color-text-secondary)"`, `fontSize: "1rem"`, wrapped in a left-border accent quote block (`borderLeft: "2px solid var(--color-accent)"`, `paddingLeft: "12px"`). Max 2 lines — truncate with ellipsis if needed (`overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical`).
      - AI explanation: `response.explanation` rendered in `<p>` tag, `fontFamily: "var(--font-ui)"`, `fontSize: "0.9rem"`, `lineHeight: "1.7"`, `color: "var(--color-text-primary)"`. Preserve newlines (white-space: pre-line).
      - Related links section: heading "Artículos relacionados" in `fontFamily: "var(--font-ui)"`, `fontSize: "0.75rem"`, uppercase, muted. Below it, render `response.relatedLinks` as `<a>` tags styled as text links with accent hover. For now href is `href={/article/${link.id}}`.
      - All padding: `24px` on sides, sections separated by `16px` gap.
    - Panel must be keyboard accessible: close on Escape key (`useEffect` with keydown listener while panel is open).

    ## ArticleBody.tsx — update to accept onExplore callback

    Update `ArticleBody` props to accept optional `onExplore?: (text: string) => void`. Wrap the existing `<div>` in `TextSelectionTrigger` if `onExplore` is provided:
    ```tsx
    // Only wrap with selection if onExplore is provided
    if (onExplore) {
      return <TextSelectionTrigger onExplore={onExplore}>{existingContent}</TextSelectionTrigger>;
    }
    return existingContent;
    ```

    ## article/[id]/page.tsx — wire explore state

    Convert `ArticlePage` to a `"use client"` component (add directive, keep async params logic in a server wrapper if needed — or make the whole page client and pass article as prop).

    Actually: Keep `page.tsx` as a server component (it fetches article). Create a new `"use client"` wrapper component `src/components/article/ArticlePageClient.tsx` that:
    - Accepts `{ article: Article }` prop
    - Holds state: `exploreText: string | null`, `profileType: string | null`
    - On mount (useEffect): reads `getProfile()` from `src/lib/profile.ts` and sets `profileType`
    - Renders:
      ```tsx
      <article className="min-h-screen px-4 py-12">
        <div className="mx-auto w-full" style={{ maxWidth: "720px" }}>
          <ArticleNav />
          <ArticleHeader article={article} />
          <ArticleToolbar />
          <ArticleBody body={article.body} onExplore={(text) => setExploreText(text)} />
          <SendToChatButton _articleTitle={article.title} />
          <NewsletterCTA />
        </div>
        <ContextualExplorePanel
          selectedText={exploreText}
          profileType={profileType}
          articleId={article.id}
          onClose={() => setExploreText(null)}
        />
      </article>
      ```
    - Update `page.tsx` to import and render `<ArticlePageClient article={article} />`.

    IMPORTANT: Use CSS var tokens for ALL colors and spacing — never hardcode hex values or use Tailwind utility classes for token colors. Phosphor icons weight="thin" always. Follow 200ms transition for all interactions.
  </action>
  <verify>
    Run `npm run build` — zero errors.
    Manually verify in browser: navigate to `/article/[any-id]`, select 10+ characters of article text, confirm floating "Explorar" button appears near the selection. Click it — confirm side panel slides in from right with explanation text, depth label, and related links. Press Escape or click X — panel dismisses. Reselect text — new panel opens with fresh content.
  </verify>
  <done>
    Text selection of 10+ characters causes floating "Explorar" button to appear.
    Clicking "Explorar" opens the side panel with: depth label badge, quoted selection, AI explanation (Spanish), related article links.
    Panel closes on X click, Escape key, or when user makes a new selection.
    Academic profile users see "Academic" label and "Referencias:" in explanation.
    General/null profile users see "General" label without references.
  </done>
</task>

</tasks>

<verification>
Run `npm run build` — passes with zero errors and zero TypeScript errors.
Navigate to an article page, select text, and confirm the full Explore flow works end-to-end: selection → floating button → panel → dismiss.
</verification>

<success_criteria>
CTX-01 through CTX-06 satisfied:
- Text selection shows floating "Explorar" button (CTX-01)
- Clicking opens side panel without navigating away (CTX-02)
- Panel shows simulated AI cultural response in Spanish (CTX-03)
- Panel shows related article links (CTX-04)
- Depth label reflects user profile type (CTX-05)
- X button and Escape key dismiss the panel (CTX-06)
</success_criteria>

<output>
After completion, create `.planning/phases/04-ai-companion/04-01-SUMMARY.md` with what was built, key decisions, and file list.
</output>
