---
phase: 04-ai-companion
plan: "03"
type: execute
wave: 2
depends_on: ["04-02"]
files_modified:
  - src/components/chat/ChatSidebar.tsx
  - src/app/(app)/chat/page.tsx
  - src/app/(app)/layout.tsx
  - src/components/layout/AppShell.tsx
autonomous: true
requirements:
  - CHAT-03
  - CHAT-04
  - CHAT-05
  - CHAT-07
  - CHAT-09

must_haves:
  truths:
    - "When chatMode is 'sidebar', the article page shrinks and a 380px chat panel appears on the right — both are visible simultaneously"
    - "The sidebar has a collapse button that returns chatMode to 'minimal'"
    - "The sidebar has an expand button that transitions chatMode to 'fullscreen'"
    - "The fullscreen chat page takes over the entire screen with no article visible"
    - "The fullscreen page has a back button that returns to sidebar mode"
    - "The chat header shows 'Discutiendo: [article title]' when an article context is set"
    - "Conversation message history is visible in both sidebar and fullscreen"
  artifacts:
    - path: "src/components/chat/ChatSidebar.tsx"
      provides: "Persistent sidebar chat panel with header, messages list, input, collapse/expand controls"
      min_lines: 100
    - path: "src/app/(app)/chat/page.tsx"
      provides: "Fullscreen chat page (P08) with message list, input, context header, back button"
      min_lines: 80
  key_links:
    - from: "src/components/chat/ChatSidebar.tsx"
      to: "src/lib/chatStore.ts"
      via: "useChatStore() for messages, articleContext, setChatMode"
      pattern: "useChatStore"
    - from: "src/app/(app)/chat/page.tsx"
      to: "src/lib/chatStore.ts"
      via: "useChatStore() reads messages, articleContext, setChatMode for back navigation"
      pattern: "useChatStore"
    - from: "src/app/(app)/layout.tsx"
      to: "src/components/chat/ChatSidebar.tsx"
      via: "Renders ChatSidebar when chatMode === 'sidebar'"
      pattern: "ChatSidebar|chatMode.*sidebar"
---

<objective>
Build the AI chat sidebar (P08b) and fullscreen chat page (P08), and wire the layout to show them based on chatMode.

Purpose: This gives users two richer chat modes beyond the bottom drawer — a persistent sidebar that keeps the article in view, and a fullscreen mode for deep conversation. Both read from the shared chatStore built in plan 04-02.
Output: ChatSidebar component, fullscreen chat page, layout updated to render sidebar when chatMode is sidebar.
</objective>

<execution_context>
@/Users/jccruzb-local/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jccruzb-local/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/chatStore.ts
@src/components/chat/ChatProvider.tsx
@src/app/(app)/layout.tsx
@src/components/layout/AppShell.tsx
@src/components/chat/GlobalChatbar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build ChatSidebar component</name>
  <files>
    src/components/chat/ChatSidebar.tsx
    src/app/(app)/layout.tsx
    src/components/layout/AppShell.tsx
  </files>
  <action>
    ## ChatSidebar.tsx

    Create `"use client"` component. Reads from `useChatStore()`:
    - `messages`, `articleContext`, `chatMode`, `setChatMode`, `addMessage`

    Structure:
    ```
    [ChatSidebar — fixed right panel, 380px wide, full height]
      [Header — context title + controls]
      [Messages list — scrollable]
      [Input area — textarea + send]
    ```

    **Panel container:**
    - `position: fixed`, `top: 0`, `right: 0`, `width: 380px`, `height: 100vh`, `zIndex: 30`
    - `display: flex`, `flexDirection: column`
    - `backgroundColor: "var(--color-surface)"`, `borderLeft: "1px solid var(--color-border)"`
    - `boxShadow: "var(--shadow-md)"`

    **Header (48px tall):**
    - Left side: If `articleContext`: show "Discutiendo:" label (muted, xs, uppercase, `fontFamily: "var(--font-ui)"`) + truncated article title below it (sm, primary color, max 1 line with ellipsis). If no articleContext: show "Compañero Cultural" as title.
    - Right side (buttons row):
      1. `ArrowsIn` Phosphor icon (weight="thin") — collapse: calls `setChatMode("minimal")`, `aria-label="Colapsar chat"`
      2. `ArrowsOut` Phosphor icon (weight="thin") — fullscreen: uses `next/navigation` router to push to `/chat`, `aria-label="Pantalla completa"`
    - Header padding: `12px 16px`, border-bottom `1px solid var(--color-border)`

    **Messages list:**
    - `flex: 1`, `overflowY: auto`, `padding: "16px"`, `display: flex`, `flexDirection: column`, `gap: "12px"`
    - Empty state: centered muted text "Inicia una conversación…" with `ChatTeardrop` icon above it (24px, accent color)
    - Each message bubble:
      - User message: aligned right, `backgroundColor: "var(--color-accent)"`, white text, `borderRadius: "var(--radius-lg) var(--radius-lg) var(--radius-sm) var(--radius-lg)"`, `padding: "8px 12px"`, max-width 80%
      - Assistant message: aligned left, `backgroundColor: "var(--color-surface-raised)"`, `color: "var(--color-text-primary)"`, `borderRadius: "var(--radius-lg) var(--radius-lg) var(--radius-lg) var(--radius-sm)"`, `padding: "8px 12px"`, max-width 80%
      - Both: `fontFamily: "var(--font-ui)"`, `fontSize: "0.875rem"`, `lineHeight: "1.6"`
    - Auto-scroll to bottom when new messages are added: `useEffect` with `scrollIntoView({ behavior: "smooth" })` on a ref attached to a dummy div at the end of the list

    **Input area (bottom):**
    - `padding: "12px 16px"`, border-top `1px solid var(--color-border)`, `backgroundColor: "var(--color-surface)"`
    - Textarea: single row initially, `resize: none`, same token styles as GlobalChatbar. `rows={1}`. Placeholder: if `articleContext`: `"Pregunta sobre «${articleContext}»…"` else `"Escribe tu pregunta…"`
    - Send button: `ArrowUp` Phosphor icon (weight="thin"), disabled when textarea empty. On click: `addMessage({ role: "user", content: inputValue })`, clears input. AI response wiring comes in plan 04-04.
    - On Enter key (without Shift): submit the message

    ## layout.tsx — render ChatSidebar conditionally

    `src/app/(app)/layout.tsx` already imports `ChatProvider` and `GlobalChatbar`. Add:
    - Import `ChatSidebar` from `@/components/chat/ChatSidebar`
    - Render `<ChatSidebar />` inside `ChatProvider`, positioned after `GlobalChatbar`. The sidebar is `position: fixed` so it overlays without affecting the document flow.
    - ChatSidebar internally reads `chatMode` and renders null if chatMode is not "sidebar". Keep this logic inside ChatSidebar, not in layout.

    ## AppShell.tsx — add right padding in sidebar mode

    The article content needs to not be hidden behind the 380px sidebar. Update `AppShell.tsx` to be a `"use client"` component that reads `useChatStore()`. When `chatMode === "sidebar"`, add `paddingRight: "380px"` to the main content area. When chatMode is anything else, no padding.

    If AppShell is currently a server component, convert to client component (`"use client"`) — it only handles layout, no SSR data.
  </action>
  <verify>
    Run `npm run build` — zero errors.
    In browser: navigate to article, send article to chat (plan 04-02), open drawer, click ArrowsOut. Confirm sidebar appears on right at 380px. Article content should shift left (not hidden behind panel). Header shows article title under "Discutiendo:". Message history area shows empty state. Input is functional (typing + Enter submits user message to store). ArrowsIn button collapses sidebar back to pill. ArrowsOut in sidebar transitions to fullscreen (route push happens — page may show 404 until 04-03 task 2 creates it).
  </verify>
  <done>
    ChatSidebar renders as a 380px fixed panel when chatMode is "sidebar".
    AppShell shifts content right to avoid overlap.
    Header correctly shows article context or default title.
    Messages render as styled bubbles (user right, assistant left).
    Empty state shown when no messages.
    Input submits user messages to the chat store.
    ArrowsIn collapses to "minimal". ArrowsOut navigates to /chat.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build fullscreen chat page (P08)</name>
  <files>src/app/(app)/chat/page.tsx</files>
  <action>
    Create `src/app/(app)/chat/page.tsx` as a `"use client"` component (fullscreen AI conversation — P08).

    This page is a full-screen layout with no sidebar, no article visible:

    ```
    [Fullscreen Chat Page — full viewport]
      [Top bar — back button + context label]
      [Messages list — scrollable, takes remaining height]
      [Input area — fixed bottom]
    ```

    **Page container:**
    - `min-height: 100vh`, `display: flex`, `flexDirection: column`
    - `backgroundColor: "var(--color-bg)"`
    - No Navbar from AppShell — this page overrides with its own top bar (the AppShell Navbar will still render from layout; that's acceptable — the chat page top bar sits below the Navbar at the top of the content area)

    **Top bar (56px):**
    - Left: `CaretLeft` Phosphor icon + "Volver al artículo" text. On click: `setChatMode("sidebar")` + `router.back()`. Uses `next/navigation` `useRouter`.
    - Center: If `articleContext`: `"Discutiendo: ${articleContext}"` — `fontFamily: "var(--font-ui)"`, `fontSize: "0.875rem"`, muted color, truncated. If no context: `"Conversación cultural"`.
    - Right: `Trash` Phosphor icon (weight="thin") — `clearMessages()`, aria-label="Limpiar conversación"
    - Border-bottom `1px solid var(--color-border)`, padding `0 24px`

    **Messages list:**
    - `flex: 1`, `overflowY: auto`, `padding: "24px"`, `maxWidth: "720px"`, `margin: "0 auto"`, `width: "100%"`
    - Same message bubble styles as ChatSidebar (user right / assistant left)
    - Empty state: centered, `ChatTeardrop` icon (32px, accent), "Empieza a explorar la cultura mexicana" heading, muted subtext "Pregunta sobre lo que acabas de leer, un movimiento cultural, un artista…"
    - Auto-scroll to bottom on new messages (same pattern as ChatSidebar)

    **Input area (bottom, `position: sticky`, `bottom: 0`):**
    - `backgroundColor: "var(--color-surface)"`, `borderTop: "1px solid var(--color-border)"`, `padding: "16px 24px"`
    - Inner div: `maxWidth: "720px"`, `margin: "0 auto"`, `display: flex`, `gap: "8px"`, `alignItems: "flex-end"`
    - Textarea: `rows={2}`, resize none, token styles. Placeholder: context-aware same as sidebar.
    - Send button: `ArrowUp` icon, same styles as sidebar send button.
    - On Enter (no Shift): submit. `addMessage({ role: "user", content: inputValue })`, clear input.

    Read from `useChatStore()`: `messages`, `articleContext`, `setChatMode`, `addMessage`, `clearMessages`.

    WCAG: All icon-only buttons have `aria-label`. Focus ring visible via `focus-visible:outline` classes.
  </action>
  <verify>
    Run `npm run build` — zero errors (new route `/chat` must generate without error).
    Navigate directly to `/chat` — page renders with top bar, empty messages state, and input area.
    From sidebar: click ArrowsOut → navigated to `/chat`, messages history preserved. Click back button → returns to article page with chatMode set to "sidebar".
    Type a message in fullscreen input → message appears in list → same message visible in sidebar if navigating back.
  </verify>
  <done>
    /chat page renders fullscreen chat layout.
    Article context shown in header when set.
    Conversation history shared with sidebar (same chatStore).
    Back button returns to article + sidebar mode.
    Trash button clears conversation history.
    User messages submitted via input appear in the message list.
  </done>
</task>

</tasks>

<verification>
Run `npm run build` — zero errors, zero TypeScript errors.
Full mode-transition flow: minimal pill → drawer → sidebar (article visible alongside) → fullscreen (full screen) → back to sidebar → collapse to pill.
Chat header correctly shows "Discutiendo: [title]" throughout all modes when article context is set.
Conversation messages persist when switching between sidebar and fullscreen.
</verification>

<success_criteria>
CHAT-03 satisfied: Sidebar mode shows article alongside chat.
CHAT-04 satisfied: Fullscreen chat mode accessible via ArrowsOut.
CHAT-05 satisfied: Fullscreen back button returns to sidebar; sidebar collapse returns to minimal.
CHAT-07 satisfied: Conversation history visible in both sidebar and fullscreen.
CHAT-09 satisfied: "Discutiendo: [article title]" shown in chat header when context is set.
</success_criteria>

<output>
After completion, create `.planning/phases/04-ai-companion/04-03-SUMMARY.md` with what was built, key decisions, and file list.
</output>
