---
phase: 02-home-feed
plan: "02"
type: execute
wave: 2
depends_on:
  - "02-01"
files_modified:
  - src/app/(app)/feed/page.tsx
  - src/lib/personalization.ts
autonomous: true
requirements:
  - FEED-01
  - FEED-02
  - FEED-05

must_haves:
  truths:
    - "A logged-in user with interests and region sees personalized carousels (For You filtered by interests, In Your Region filtered by region)"
    - "A guest user (no localStorage session) sees the feed without crashing — generic fallback content shown"
    - "The feed page does not break if onboarding is incomplete"
  artifacts:
    - path: "src/lib/personalization.ts"
      provides: "getPersonalizedFeed() — returns { hero, forYou, inRegion, discover } article sets based on user profile"
      exports: ["getPersonalizedFeed"]
  key_links:
    - from: "src/app/(app)/feed/page.tsx"
      to: "src/lib/personalization.ts"
      via: "getPersonalizedFeed call"
      pattern: "getPersonalizedFeed\\("
---

<objective>
Wire personalization into the feed: logged-in users see articles filtered by their interests and region. Guest users see a graceful generic fallback. The feed must never crash regardless of profile state.

Purpose: Onboarding data needs to drive the feed — this is ONBD-06's payoff. Without it the feed is just a static list.
Output: Feed carousels respond to the user's interests and region from localStorage.
</objective>

<tasks>

<task type="auto">
  <name>Task 1: Personalization engine + feed wiring</name>
  <files>
    src/lib/personalization.ts
    src/app/(app)/feed/page.tsx
  </files>
  <action>
The feed page is a Server Component but personalization reads from localStorage (client-only). Solution: make feed/page.tsx a Client Component that reads profile on mount and renders personalized content — or use a simpler pattern: keep feed as server component for shell, add a client PersonalizedFeed component that reads localStorage and renders the carousels.

Use this pattern:
- `src/app/(app)/feed/page.tsx` becomes a thin server shell that renders `<FeedContent />`
- `src/components/feed/FeedContent.tsx` is a Client Component that reads profile and renders personalized carousels

1. Create `src/lib/personalization.ts`:

```ts
import { getArticles, type Article } from "@/lib/articles";
import type { UserProfile } from "@/lib/types";

export interface PersonalizedFeed {
  hero: Article;
  forYou: Article[];
  inRegion: Article[];
  discover: Article[];
}

export function getPersonalizedFeed(profile: UserProfile | null): PersonalizedFeed {
  const all = getArticles();

  if (!profile || !profile.onboardingComplete) {
    // Guest or incomplete onboarding — return generic slices
    return {
      hero: all[0],
      forYou: all.slice(1, 5),
      inRegion: all.slice(5, 9),
      discover: all.slice(9, 12),
    };
  }

  // For You — filter by user interests, fallback to all
  const byInterests = all.filter((a) =>
    a.tags.some((tag) => profile.interests.includes(tag))
  );
  const forYou = byInterests.length >= 2 ? byInterests.slice(0, 4) : all.slice(0, 4);

  // In Your Region — filter by region, fallback to all
  const byRegion = profile.region
    ? all.filter((a) => a.regionTags.includes(profile.region!))
    : [];
  const inRegion = byRegion.length >= 2 ? byRegion.slice(0, 4) : all.slice(4, 8);

  // Discover — articles NOT in forYou or inRegion, or last slice
  const usedIds = new Set([...forYou, ...inRegion].map((a) => a.id));
  const discover = all.filter((a) => !usedIds.has(a.id)).slice(0, 4);

  // Hero — top forYou article, or first article
  const hero = forYou[0] ?? all[0];

  return { hero, forYou: forYou.slice(1), inRegion, discover };
}
```

2. Create `src/components/feed/FeedContent.tsx` — Client Component:
```tsx
"use client";
import { useState, useEffect } from "react";
import { getProfile } from "@/lib/profile";
import { getPersonalizedFeed } from "@/lib/personalization";
import { HeroSection } from "./HeroSection";
import { CarouselSection } from "./CarouselSection";
import type { UserProfile } from "@/lib/types";

export function FeedContent() {
  const [profile, setProfile] = useState<UserProfile | null>(null);
  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    setProfile(getProfile());
    setMounted(true);
  }, []);

  // Avoid hydration mismatch — show skeleton until mounted
  if (!mounted) {
    return <FeedSkeleton />;
  }

  const feed = getPersonalizedFeed(profile);
  const regionLabel = profile?.region ? `In ${profile.region} Mexico` : "In Your Region";

  return (
    <>
      <HeroSection article={feed.hero} />
      <div className="max-w-5xl mx-auto px-4 py-12">
        <CarouselSection
          title="For You"
          subtitle={profile?.onboardingComplete ? "Based on your interests" : "Top cultural reads"}
          articles={feed.forYou}
        />
        <CarouselSection
          title={regionLabel}
          articles={feed.inRegion}
        />
        <CarouselSection
          title="Discover Mexico"
          articles={feed.discover}
        />
      </div>
    </>
  );
}

function FeedSkeleton() {
  return (
    <div className="animate-pulse">
      {/* Hero skeleton */}
      <div className="bg-surface-raised border-b border-border py-16 px-4">
        <div className="max-w-5xl mx-auto space-y-4">
          <div className="h-4 w-24 rounded-full bg-washi-200" />
          <div className="h-10 w-2/3 rounded bg-washi-200" />
          <div className="h-6 w-1/2 rounded bg-washi-200" />
        </div>
      </div>
      {/* Carousel skeleton */}
      <div className="max-w-5xl mx-auto px-4 py-12 space-y-12">
        {[1, 2, 3].map((i) => (
          <div key={i} className="space-y-4">
            <div className="h-6 w-40 rounded bg-washi-200" />
            <div className="flex gap-4">
              {[1, 2, 3].map((j) => (
                <div key={j} className="min-w-[280px] h-40 rounded-lg bg-washi-200" />
              ))}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}
```

3. Update `src/app/(app)/feed/page.tsx` to use FeedContent:
```tsx
import { FeedContent } from "@/components/feed/FeedContent";

export default function FeedPage() {
  return <FeedContent />;
}
```
  </action>
  <verify>
1. Run `npm run dev` — visit /feed while logged in with interests selected — "For You" cards match selected interests.
2. Open DevTools → Application → clear localStorage → refresh /feed — page renders without crash, shows generic content.
3. Run `npm run build` — zero TypeScript errors.
  </verify>
  <done>Feed personalized for logged-in users (interests + region filtering). Guest/incomplete profile shows graceful generic fallback. Skeleton shown during hydration. No crashes on empty/null profile.</done>
</task>

</tasks>

<verification>
1. `npm run build` — zero errors
2. Logged-in user: "For You" filtered by their interests
3. Guest (no localStorage): feed renders, no crash
4. Skeleton visible briefly on mount (hydration safe)
</verification>

<success_criteria>
- FEED-01: Logged-in user sees personalized "For You" carousel filtered by interests
- FEED-02: "In Your Region" filtered by user's region (or generic fallback)
- FEED-05: Guest user sees feed without crash
</success_criteria>

<output>
After completion, create `.planning/phases/02-home-feed/02-02-SUMMARY.md`
</output>
