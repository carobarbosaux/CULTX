---
phase: 02-home-feed
plan: "03"
type: execute
wave: 3
depends_on:
  - "02-02"
files_modified:
  - src/components/feed/CompanionCard.tsx
  - src/components/chat/GlobalChatbar.tsx
  - src/app/(app)/layout.tsx
  - src/app/(app)/feed/page.tsx
autonomous: true
requirements:
  - FEED-06
  - FEED-07

must_haves:
  truths:
    - "A Proactive Cultural Companion card appears on the feed surface"
    - "The Companion card is dismissible and stays dismissed (sessionStorage)"
    - "The Global Chatbar is visible at the bottom of the feed page in its minimal state"
    - "The Chatbar shows a context-aware placeholder text"
    - "The Chatbar is non-functional (UI only) — click opens an inline expanded state with input"
  artifacts:
    - path: "src/components/feed/CompanionCard.tsx"
      provides: "Dismissible proactive companion suggestion card with 3 rotating suggestions"
      exports: ["CompanionCard"]
    - path: "src/components/chat/GlobalChatbar.tsx"
      provides: "Sticky bottom chatbar in minimal state with placeholder and expand-on-click"
      exports: ["GlobalChatbar"]
  key_links:
    - from: "src/app/(app)/layout.tsx"
      to: "src/components/chat/GlobalChatbar.tsx"
      via: "renders GlobalChatbar at bottom of layout"
      pattern: "<GlobalChatbar"
---

<objective>
Add the two persistent UI companions to the feed: the Proactive Companion card (contextual suggestion, dismissible) and the Global Chatbar (sticky bottom bar, minimal state, UI-only expand). These establish the AI presence in the product without requiring real AI functionality.

Purpose: FEED-06 and FEED-07. These components will be reused in Phase 3 (Article page) and wired with real interaction in Phase 4 (AI Companion).
Output: Companion card renders in feed above carousels. Chatbar docked to bottom of screen on all app pages.
</objective>

<tasks>

<task type="auto">
  <name>Task 1: Proactive Companion card</name>
  <files>
    src/components/feed/CompanionCard.tsx
    src/app/(app)/feed/page.tsx (update FeedContent to include CompanionCard)
  </files>
  <action>
1. Create `src/components/feed/CompanionCard.tsx`:

The companion card is a subtle, warm suggestion that appears above the "For You" carousel. It rotates between 3 suggestion types on each visit. It is dismissible with an X button. Dismissed state persists in sessionStorage (reappears next session).

```tsx
"use client";
import { useState, useEffect } from "react";
import { X, Sparkle, Headphones, BookOpen } from "@phosphor-icons/react";

const SUGGESTIONS = [
  {
    icon: BookOpen,
    label: "Explore a cultural thread",
    description: "Dive deeper into Architecture and its connections across Mexico.",
    cta: "Start exploring",
  },
  {
    icon: Sparkle,
    label: "Try contextual explore",
    description: "Select any text in an article to get cultural context instantly.",
    cta: "See how it works",
  },
  {
    icon: Headphones,
    label: "Turn this into a 5-min listen",
    description: "Generate an audio summary of any article to read on the go.",
    cta: "Try audio mode",
  },
];

export function CompanionCard() {
  const [dismissed, setDismissed] = useState(false);
  const [suggestionIndex, setSuggestionIndex] = useState(0);
  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    const wasDismissed = sessionStorage.getItem("cultx:companion-dismissed") === "true";
    setDismissed(wasDismissed);
    setSuggestionIndex(Math.floor(Math.random() * SUGGESTIONS.length));
    setMounted(true);
  }, []);

  if (!mounted || dismissed) return null;

  const suggestion = SUGGESTIONS[suggestionIndex];
  const Icon = suggestion.icon;

  return (
    <div
      className="relative rounded-lg border p-4 mb-8"
      style={{
        borderColor: "var(--color-sage-300)",
        backgroundColor: "var(--color-washi-100)",
      }}
    >
      <button
        type="button"
        onClick={() => {
          sessionStorage.setItem("cultx:companion-dismissed", "true");
          setDismissed(true);
        }}
        aria-label="Dismiss companion suggestion"
        className="absolute top-3 right-3 p-1 rounded transition-colors duration-[200ms] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[var(--color-focus-ring)]"
        style={{ color: "var(--color-text-muted)" }}
      >
        <X size={14} weight="thin" />
      </button>

      <div className="flex items-start gap-3 pr-6">
        <div
          className="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center mt-0.5"
          style={{ backgroundColor: "var(--color-sage-400)", color: "#fff" }}
        >
          <Icon size={16} weight="thin" />
        </div>
        <div>
          <p
            className="text-xs font-medium uppercase tracking-widest mb-1"
            style={{ color: "var(--color-accent)", fontFamily: "var(--font-ui)" }}
          >
            Cultural Companion
          </p>
          <p
            className="text-base font-medium"
            style={{ fontFamily: "var(--font-display)", color: "var(--color-text-primary)" }}
          >
            {suggestion.label}
          </p>
          <p
            className="text-sm mt-1"
            style={{ fontFamily: "var(--font-ui)", color: "var(--color-text-secondary)" }}
          >
            {suggestion.description}
          </p>
          <button
            type="button"
            className="text-sm font-medium mt-2 transition-colors duration-[200ms] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[var(--color-focus-ring)]"
            style={{ color: "var(--color-accent)", fontFamily: "var(--font-ui)" }}
          >
            {suggestion.cta} →
          </button>
        </div>
      </div>
    </div>
  );
}
```

2. Update `src/components/feed/FeedContent.tsx` to render `<CompanionCard />` above the carousels section (inside the `max-w-5xl` container, before the first CarouselSection).
  </action>
  <verify>CompanionCard appears above "For You" carousel. X button dismisses it. Refreshing page keeps it dismissed (sessionStorage). Different suggestion shown on next session.</verify>
  <done>CompanionCard renders on feed above carousels. Dismissible with X. sessionStorage persists dismissed state. Icon + label + description + CTA all render with Japandi tokens.</done>
</task>

<task type="auto">
  <name>Task 2: Global Chatbar — sticky bottom, minimal state</name>
  <files>
    src/components/chat/GlobalChatbar.tsx
    src/app/(app)/layout.tsx
  </files>
  <action>
1. Create `src/components/chat/GlobalChatbar.tsx`:

The chatbar lives at the bottom of every app page (docked). It has two states:
- **Minimal**: single-line pill/bar — shows icon + placeholder text + expand hint
- **Expanded**: taller input area with a text input and send button (UI only — no real send)

The expanded state opens inline (no modal/drawer yet — that's Phase 4). For Phase 2 this is purely UI.

```tsx
"use client";
import { useState } from "react";
import { ChatTeardrop, ArrowUp, X } from "@phosphor-icons/react";

export function GlobalChatbar() {
  const [expanded, setExpanded] = useState(false);
  const [inputValue, setInputValue] = useState("");

  if (!expanded) {
    return (
      <div className="fixed bottom-0 left-0 right-0 z-40 flex justify-center px-4 pb-4 pointer-events-none">
        <button
          type="button"
          onClick={() => setExpanded(true)}
          aria-label="Open AI cultural companion chat"
          className="pointer-events-auto flex items-center gap-3 rounded-full border px-5 py-3 shadow-md transition-shadow duration-[200ms] hover:shadow-lg focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[var(--color-focus-ring)]"
          style={{
            borderColor: "var(--color-border)",
            backgroundColor: "var(--color-surface)",
            boxShadow: "var(--shadow-md)",
          }}
        >
          <ChatTeardrop size={18} weight="thin" style={{ color: "var(--color-accent)" }} />
          <span
            className="text-sm"
            style={{ fontFamily: "var(--font-ui)", color: "var(--color-text-muted)" }}
          >
            Ask about Mexican culture…
          </span>
        </button>
      </div>
    );
  }

  return (
    <div
      className="fixed bottom-0 left-0 right-0 z-40 border-t px-4 py-3"
      style={{
        borderColor: "var(--color-border)",
        backgroundColor: "var(--color-surface)",
        boxShadow: "var(--shadow-md)",
      }}
    >
      <div className="max-w-2xl mx-auto flex items-end gap-2">
        <div className="flex-1">
          <textarea
            value={inputValue}
            onChange={(e) => setInputValue(e.target.value)}
            placeholder="Ask about Mexican culture, an article, or a cultural thread…"
            rows={2}
            aria-label="Chat with AI cultural companion"
            className="w-full resize-none rounded-lg border px-4 py-2.5 text-sm focus:outline-none focus:border-[var(--color-accent)] focus:ring-1 focus:ring-[var(--color-accent)] transition-[border-color] duration-[200ms]"
            style={{
              borderColor: "var(--color-border)",
              backgroundColor: "var(--color-bg)",
              color: "var(--color-text-primary)",
              fontFamily: "var(--font-ui)",
            }}
          />
        </div>
        <div className="flex flex-col gap-1.5 pb-0.5">
          <button
            type="button"
            onClick={() => setExpanded(false)}
            aria-label="Close chat"
            className="p-1.5 rounded transition-colors duration-[200ms] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[var(--color-focus-ring)]"
            style={{ color: "var(--color-text-muted)" }}
          >
            <X size={16} weight="thin" />
          </button>
          <button
            type="button"
            aria-label="Send message"
            disabled={!inputValue.trim()}
            className="p-1.5 rounded-full transition-colors duration-[200ms] disabled:opacity-40 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[var(--color-focus-ring)]"
            style={{
              backgroundColor: inputValue.trim() ? "var(--color-accent)" : "var(--color-surface-raised)",
              color: inputValue.trim() ? "#fff" : "var(--color-text-muted)",
            }}
          >
            <ArrowUp size={16} weight="thin" />
          </button>
        </div>
      </div>
    </div>
  );
}
```

2. Update `src/app/(app)/layout.tsx` to render `<GlobalChatbar />` below the AppShell:
```tsx
import { AppShell } from "@/components/layout/AppShell";
import { GlobalChatbar } from "@/components/chat/GlobalChatbar";

export default function AppLayout({ children }: { children: React.ReactNode }) {
  return (
    <>
      <AppShell>{children}</AppShell>
      <GlobalChatbar />
    </>
  );
}
```

Add bottom padding to AppShell children so content doesn't hide behind the chatbar. Update `src/components/layout/AppShell.tsx` to add `pb-24` to the `<main>` element.
  </action>
  <verify>
1. Chatbar pill visible at bottom of /feed. Click → expands to textarea. X collapses back.
2. Chatbar appears on every (app) route (it's in the layout).
3. No content hidden behind chatbar (pb-24 on main).
4. Run `npm run build` — zero TypeScript errors.
  </verify>
  <done>GlobalChatbar docked to bottom on all app pages. Minimal pill state with ChatTeardrop icon + placeholder. Expands to textarea on click. Collapses with X. Content has bottom padding to avoid overlap.</done>
</task>

</tasks>

<verification>
1. `npm run build` — zero errors
2. CompanionCard renders above feed carousels, dismisses with X
3. GlobalChatbar pill visible at bottom, expands and collapses
4. Feed page bottom content not hidden behind chatbar
</verification>

<success_criteria>
- FEED-06: Proactive Companion card appears on feed, is dismissible, uses warm Japandi styling (sage-300 border, washi-100 bg)
- FEED-07: Global Chatbar visible at bottom in minimal pill state with context-aware placeholder
- Chatbar expands to input state on click
- All new components use design tokens; no hardcoded colors outside token vars
</success_criteria>

<output>
After completion, create `.planning/phases/02-home-feed/02-03-SUMMARY.md`
</output>
