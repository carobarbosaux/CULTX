---
phase: 01-foundation
plan: "03"
type: execute
wave: 3
depends_on:
  - "01-01"
  - "01-02"
files_modified:
  - src/app/(onboarding)/layout.tsx
  - src/app/(onboarding)/interests/page.tsx
  - src/app/(onboarding)/profile-type/page.tsx
  - src/app/(onboarding)/region/page.tsx
  - src/app/(onboarding)/exploration-mode/page.tsx
  - src/lib/profile.ts
  - src/components/onboarding/OnboardingShell.tsx
  - src/components/onboarding/InterestChip.tsx
  - src/components/onboarding/ProgressBar.tsx
autonomous: true
requirements:
  - ONBD-01
  - ONBD-02
  - ONBD-03
  - ONBD-04
  - ONBD-05
  - ONBD-06

must_haves:
  truths:
    - "A logged-in user is redirected to /onboarding/interests after signup"
    - "User can multi-select at least 1 cultural interest from 11 options before proceeding (validation enforced)"
    - "User can select a profile type (General audience / Student / Academic / Cultural professional)"
    - "User can select a region (North / Central / South / West / Peninsula)"
    - "User can select an exploration mode (My region / Entire Mexico / Both)"
    - "Completing the final step saves all selections to localStorage cultx:user and redirects to /feed"
    - "Each onboarding step shows a progress indicator (step N of 4)"
    - "Onboarding uses Japandi Calm Tech design tokens throughout"
  artifacts:
    - path: "src/lib/profile.ts"
      provides: "updateProfile, getProfile functions for reading/writing UserProfile to localStorage"
      exports: ["updateProfile", "getProfile", "completeOnboarding"]
    - path: "src/app/(onboarding)/interests/page.tsx"
      provides: "P02 interests multi-select with validation (min 1 interest)"
      exports: ["default"]
    - path: "src/app/(onboarding)/profile-type/page.tsx"
      provides: "P03 profile type single-select (4 options)"
      exports: ["default"]
    - path: "src/app/(onboarding)/region/page.tsx"
      provides: "P04 region single-select (5 Mexican regions)"
      exports: ["default"]
    - path: "src/app/(onboarding)/exploration-mode/page.tsx"
      provides: "P05 exploration mode single-select (3 options)"
      exports: ["default"]
    - path: "src/components/onboarding/ProgressBar.tsx"
      provides: "Step indicator showing current/total onboarding steps"
      exports: ["ProgressBar"]
    - path: "src/components/onboarding/InterestChip.tsx"
      provides: "Toggle chip for interest multi-select with selected/unselected states"
      exports: ["InterestChip"]
  key_links:
    - from: "src/app/(onboarding)/interests/page.tsx"
      to: "src/lib/profile.ts"
      via: "updateProfile on step completion"
      pattern: "updateProfile\\("
    - from: "src/app/(onboarding)/exploration-mode/page.tsx"
      to: "src/lib/profile.ts"
      via: "completeOnboarding on final step"
      pattern: "completeOnboarding\\("
    - from: "src/lib/profile.ts"
      to: "localStorage"
      via: "localStorage.setItem('cultx:user', ...)"
      pattern: "localStorage\\.setItem.*cultx:user"
---

<objective>
Implement the 4-step onboarding flow (P02–P05): interests, profile type, region, exploration mode. Each step saves progress to localStorage and advances to the next. Final step sets onboardingComplete: true and redirects to /feed.

Purpose: Onboarding captures the personalization data that drives the home feed and AI companion depth. Without it, subsequent phases have no user profile to personalize against.
Output: 4 onboarding pages with validated selections, progress tracking, and profile persistence.
</objective>

<execution_context>
@/Users/jccruzb-local/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jccruzb-local/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@claude.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Profile persistence lib and onboarding shell components</name>
  <files>
    src/lib/profile.ts
    src/components/onboarding/OnboardingShell.tsx
    src/components/onboarding/InterestChip.tsx
    src/components/onboarding/ProgressBar.tsx
    src/app/(onboarding)/layout.tsx
  </files>
  <action>
1. Create `src/lib/profile.ts` — functions for reading and updating UserProfile in localStorage:

```ts
import { LOCAL_STORAGE_KEYS } from "@/lib/constants";
import type { UserProfile } from "@/lib/types";

export function getProfile(): UserProfile | null {
  if (typeof window === "undefined") return null;
  const stored = localStorage.getItem(LOCAL_STORAGE_KEYS.USER);
  return stored ? JSON.parse(stored) : null;
}

export function updateProfile(updates: Partial<UserProfile>): UserProfile | null {
  if (typeof window === "undefined") return null;
  const current = getProfile();
  if (!current) return null;
  const updated = { ...current, ...updates };
  localStorage.setItem(LOCAL_STORAGE_KEYS.USER, JSON.stringify(updated));
  return updated;
}

export function completeOnboarding(finalUpdates: Partial<UserProfile>): UserProfile | null {
  return updateProfile({ ...finalUpdates, onboardingComplete: true });
}
```

2. Create `src/components/onboarding/ProgressBar.tsx` — shows step N of total:

```tsx
interface ProgressBarProps {
  current: number;  // 1-based
  total: number;
}

export function ProgressBar({ current, total }: ProgressBarProps) {
  const percentage = (current / total) * 100;
  return (
    <div className="w-full space-y-2">
      <div className="flex justify-between text-xs text-text-muted font-ui">
        <span>Step {current} of {total}</span>
      </div>
      <div className="h-1 w-full rounded-full bg-surface-raised overflow-hidden">
        <div
          className="h-full rounded-full bg-accent transition-[width] duration-base"
          style={{ width: `${percentage}%` }}
          role="progressbar"
          aria-valuenow={current}
          aria-valuemin={1}
          aria-valuemax={total}
          aria-label={`Onboarding step ${current} of ${total}`}
        />
      </div>
    </div>
  );
}
```

3. Create `src/components/onboarding/InterestChip.tsx` — toggleable chip for interest selection:

```tsx
import { cn } from "@/lib/utils";

interface InterestChipProps {
  label: string;
  selected: boolean;
  onToggle: (label: string) => void;
}

export function InterestChip({ label, selected, onToggle }: InterestChipProps) {
  return (
    <button
      type="button"
      onClick={() => onToggle(label)}
      aria-pressed={selected}
      className={cn(
        "rounded-full border px-4 py-2 text-sm font-ui transition-[background-color,border-color,color] duration-base",
        "focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-focus-ring",
        selected
          ? "border-accent bg-accent text-surface"
          : "border-border bg-surface text-text-secondary hover:border-accent hover:text-text-primary"
      )}
    >
      {label}
    </button>
  );
}
```

4. Create `src/components/onboarding/OnboardingShell.tsx` — layout wrapper for onboarding steps:

```tsx
import { ProgressBar } from "./ProgressBar";

interface OnboardingShellProps {
  step: number;
  totalSteps?: number;
  title: string;
  subtitle?: string;
  children: React.ReactNode;
}

export function OnboardingShell({ step, totalSteps = 4, title, subtitle, children }: OnboardingShellProps) {
  return (
    <div className="min-h-screen bg-bg flex flex-col items-center justify-center px-4 py-12">
      <div className="w-full max-w-lg space-y-8">
        {/* Wordmark */}
        <div className="text-center">
          <span className="font-display text-2xl font-semibold text-text-primary">CULTX</span>
        </div>

        {/* Progress */}
        <ProgressBar current={step} total={totalSteps} />

        {/* Heading */}
        <div className="space-y-2">
          <h1 className="font-display text-3xl font-semibold text-text-primary">{title}</h1>
          {subtitle && <p className="font-ui text-sm text-text-secondary">{subtitle}</p>}
        </div>

        {/* Step content */}
        {children}
      </div>
    </div>
  );
}
```

5. Create `src/app/(onboarding)/layout.tsx` — minimal layout (no AppShell/Navbar for onboarding):
```tsx
export default function OnboardingLayout({ children }: { children: React.ReactNode }) {
  return <>{children}</>;
}
```
  </action>
  <verify>
Run `npm run build` — all new files compile without TypeScript errors. `getProfile`, `updateProfile`, `completeOnboarding` all export correctly. `ProgressBar`, `InterestChip`, `OnboardingShell` render without prop errors.
  </verify>
  <done>Profile lib exports getProfile, updateProfile, completeOnboarding. ProgressBar shows correct step fraction with animated progress fill. InterestChip toggles aria-pressed and visual selected state. OnboardingShell renders step title, progress bar, and content slot.</done>
</task>

<task type="auto">
  <name>Task 2: Onboarding pages P02–P05 with validation and navigation</name>
  <files>
    src/app/(onboarding)/interests/page.tsx
    src/app/(onboarding)/profile-type/page.tsx
    src/app/(onboarding)/region/page.tsx
    src/app/(onboarding)/exploration-mode/page.tsx
  </files>
  <action>
Each page uses OnboardingShell, persists selections to localStorage via profile lib, and navigates to the next step. All pages are Client Components ("use client").

**Page 1: `src/app/(onboarding)/interests/page.tsx`** (P02)

- OnboardingShell step={1} title="What are your cultural interests?" subtitle="Select at least one to personalize your experience"
- Render all 11 interests from CULTURAL_INTERESTS constant as InterestChip grid (`flex flex-wrap gap-3`)
- useState for selected: string[] — initialize from getProfile()?.interests ?? []
- Validation: "Continue" button disabled and shows "Select at least one interest" error text when selected.length === 0
- On "Continue": call `updateProfile({ interests: selected })`, then `router.push("/onboarding/profile-type")`
- Continue button: `<Button variant="primary" className="w-full mt-8">Continue</Button>`

**Page 2: `src/app/(onboarding)/profile-type/page.tsx`** (P03)

- OnboardingShell step={2} title="How do you engage with culture?" subtitle="This shapes how the AI companion responds"
- Display 4 profile type options as selection cards (not chips — larger format):
  Each card: `<button>` with role="radio", aria-checked, full-width, rounded-lg border, padding p-4
  Card content: option name as `font-display text-lg` + short descriptor in text-secondary:
    - "General audience" → "Cultural curiosity, accessible explanations"
    - "Student" → "Learning-focused, structured context"
    - "Academic" → "Deep analysis, references and citations"
    - "Cultural professional" → "Industry perspective, practice-oriented"
  Selected state: border-accent bg-surface-raised
  Unselected: border-border hover:border-washi-300
- useState for selected: ProfileType | null — initialize from getProfile()?.profileType ?? null
- "Continue" button disabled when nothing selected
- On "Continue": `updateProfile({ profileType: selected })`, then `router.push("/onboarding/region")`
- "Back" link: `<button onClick={() => router.back()}>` styled as ghost with Phosphor ArrowLeft icon

**Page 3: `src/app/(onboarding)/region/page.tsx`** (P04)

- OnboardingShell step={3} title="Where in Mexico are you based?" subtitle="Used for regional content highlights"
- Display 5 region options (North / Central / South / West / Peninsula) as selection cards
  Same card format as profile-type page
  Add short geographic context as subtitle per card:
    - "North" → "Sonora, Chihuahua, Nuevo León and more"
    - "Central" → "Mexico City, Puebla, Querétaro and more"
    - "South" → "Oaxaca, Chiapas, Guerrero and more"
    - "West" → "Jalisco, Colima, Nayarit and more"
    - "Peninsula" → "Yucatán, Campeche, Quintana Roo"
- Note: region is optional context (claude.md says geolocation is secondary). Add subtle "Skip for now" text link that calls `updateProfile({ region: null })` and navigates forward.
- On "Continue": `updateProfile({ region: selected })`, then `router.push("/onboarding/exploration-mode")`

**Page 4: `src/app/(onboarding)/exploration-mode/page.tsx`** (P05)

- OnboardingShell step={4} title="How do you want to explore?" subtitle="Choose your default discovery scope"
- Display 3 exploration mode options as selection cards:
    - "My region" → "Focus on cultural content from your selected region"
    - "Entire Mexico" → "Discover culture from every corner of Mexico"
    - "Both" → "Regional highlights plus national discovery"
- On "Continue": call `completeOnboarding({ explorationMode: selected })`, then `router.push("/feed")`
  This is the final step — completeOnboarding sets onboardingComplete: true
- "Continue" button text on last step: "Start exploring"
- On completion, the cultx:user localStorage profile will have: interests[], profileType, region, explorationMode, onboardingComplete: true

**Shared navigation requirements:**
- All pages redirect to /login if no authenticated user in localStorage (guard: check getCurrentUser() in useEffect, if null router.push("/login"))
- All "Continue" buttons use `<Button variant="primary" className="w-full">`
- Back navigation on steps 2-4 via router.back()
- Phosphor ArrowLeft icon (thin weight) on Back button, aria-label="Go back"
  </action>
  <verify>
1. Run `npm run dev` — visit localhost:3000/signup, create an account, flow should auto-redirect to /onboarding/interests.
2. /onboarding/interests — "Continue" button disabled initially. Select 2 interests → button enables. Click Continue → goes to /profile-type.
3. Complete all 4 steps. After final "Start exploring" → redirects to /feed (404 expected, not built yet).
4. Open DevTools > Application > localStorage > cultx:user — verify: interests has selected items, profileType set, region set (or null if skipped), explorationMode set, onboardingComplete: true.
5. Refresh /onboarding/interests while logged out → should redirect to /login.
6. Run `npm run build` — zero TypeScript errors.
  </verify>
  <done>
- All 4 onboarding pages render with Japandi Calm Tech styling (Cormorant Garamond headings, DM Sans text, sage accent for selected states)
- ONBD-01: 11 interests displayed as toggleable chips, multi-select works
- ONBD-02: Continue disabled until at least 1 interest selected
- ONBD-03: 4 profile type options displayed as selection cards
- ONBD-04: 5 region options with geographic subtitles + optional Skip
- ONBD-05: 3 exploration modes displayed as selection cards
- ONBD-06: Final step saves all 4 selections to localStorage cultx:user with onboardingComplete: true
- ProgressBar shows correct step (1/4, 2/4, 3/4, 4/4) throughout flow
- Auth guard redirects to /login if no active session
  </done>
</task>

</tasks>

<verification>
1. Complete full flow: signup → interests (select 3) → profile type → region → exploration mode → localStorage confirms onboardingComplete: true with all fields populated
2. `npm run build` — zero TypeScript errors
3. Refresh after each onboarding step — selections preserved (loaded from localStorage on init)
4. Try advancing from interests with 0 selected — button stays disabled, error message shown
5. Attempt direct URL access to /onboarding/interests while logged out → redirects to /login
6. All screens render with consistent Japandi tokens: washi paper backgrounds, sage accent on selected states, Cormorant Garamond headings
</verification>

<success_criteria>
- ONBD-01: All 11 interest options render as InterestChip components in a flex-wrap grid
- ONBD-02: Interests "Continue" button disabled with error text until at least 1 interest selected
- ONBD-03: Profile type selection (4 options) as card-style radio inputs
- ONBD-04: Region selection (5 Mexican regions) with geographic subtitles; Skip available
- ONBD-05: Exploration mode selection (3 options) with descriptive subtitles
- ONBD-06: completeOnboarding() persists { interests, profileType, region, explorationMode, onboardingComplete: true } to localStorage
- ProgressBar shows step 1/4 through 4/4 across onboarding screens
- All screens use design tokens: DS-01 (Washi Paper bg), DS-02 (Cormorant + DM Sans), DS-03 (4px grid spacing), DS-04 (200ms transitions), DS-05 (WCAG AA — sage-500 on washi-50 passes 4.5:1), DS-06 (Phosphor thin icons on navigation)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
